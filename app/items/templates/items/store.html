{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="scroll-container store-container">
    <!-- Cabe√ßalho da loja -->
    <div class="store-header">
        <h1 class="store-title">üè™ Loja do Mercador</h1>
        <p class="store-subtitle">Compre e venda itens com o comerciante local</p>
    </div>

    <!-- Dinheiro do personagem -->
    <div class="store-gold">
        <span class="store-gold-icon">üí∞</span>
        <span class="store-gold-text">Ouro: <span class="store-gold-amount">{{ character.gold }}</span></span>
    </div>

    <!-- Layout de duas colunas -->
    <div class="store-columns">
        <!-- Coluna da esquerda - Comprar itens -->
        <div class="store-section">
            <h2 class="store-section-title">üõí Comprar Itens</h2>
            
            <div class="store-content">
                <div class="store-item-list">
                    {% for si in store_items %}
                    <div class="store-item-card store-rarity-{{ si.item.rarity }}">
                        <div class="store-item-header">
                            <span class="store-item-emoji">{{ si.item.emoji }}</span>
                            <div class="store-item-info">
                                <h5 class="store-item-name">{{ si.item.name }}</h5>
                                <p class="store-item-description">{{ si.item.description }}</p>
                            </div>
                        </div>
                        
                        <div class="store-item-details">
                            <div class="store-price-info">
                                <span class="store-price-tag">üí∞ {{ si.buy_price }} ouro</span>
                            </div>
                            <div class="store-stock-info">
                                {% if si.unlimited %}
                                    <span class="store-stock-unlimited">‚àû</span>
                                {% else %}
                                    <span class="store-stock-limited">üì¶ Estoque: {{ si.stock }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <button class="store-action-btn store-buy-btn" onclick="storeBuyItem({{ si.id }})">
                            üõí Comprar
                        </button>
                    </div>
                    {% empty %}
                    <div class="store-empty-message">
                        Nenhum item dispon√≠vel na loja.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Coluna da direita - Vender itens -->
        <div class="store-section">
            <h2 class="store-section-title">üí∞ Vender Itens</h2>
            
            <div class="store-content">
                <div class="store-item-list">
                    {% for inv in inventory %}
                    <div class="store-item-card store-rarity-{{ inv.item.rarity }}">
                        <div class="store-item-header">
                            <span class="store-item-emoji">{{ inv.item.emoji }}</span>
                            <div class="store-item-info">
                                <h5 class="store-item-name">{{ inv.item.name }}</h5>
                                <p class="store-item-description">{{ inv.item.description }}</p>
                            </div>
                        </div>
                        
                        <div class="store-item-details">
                            <div class="store-quantity-info">
                                <span class="store-quantity-tag">üì¶ Voc√™ tem: {{ inv.quantity }}</span>
                            </div>
                            <div class="store-sell-price-info">
                                <span class="store-sell-price">Valor: {{ inv.item.sell_price }} üí∞</span>
                            </div>
                        </div>
                        
                        <button class="store-action-btn store-sell-btn" onclick="storeSellItem({{ inv.item.id }})">
                            üí∞ Vender
                        </button>
                    </div>
                    {% empty %}
                    <div class="store-empty-message">
                        Seu invent√°rio est√° vazio.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o para obter o token CSRF
function storeGetCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const storeCsrftoken = storeGetCookie('csrftoken');

// Fun√ß√£o de compra
function storeBuyItem(storeItemId) {
    const quantity = prompt("Quantidade para comprar:", "1");
    if (!quantity || isNaN(quantity) || quantity <= 0) return;
    
    if (!confirm(`Deseja comprar ${quantity} unidade(s) deste item?`)) return;
    
    fetch("/items/store/buy/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": storeCsrftoken
        },
        body: JSON.stringify({
            store_item_id: storeItemId,
            quantity: parseInt(quantity)
        })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            storeShowNotification('success', data.message || 'Item comprado com sucesso!');
            setTimeout(() => location.reload(), 1500);
        } else {
            storeShowNotification('error', data.error || 'Erro ao comprar item');
        }
    }).catch(error => {
        console.error('Error:', error);
        storeShowNotification('error', 'Erro de conex√£o');
    });
}

// Fun√ß√£o de venda
function storeSellItem(itemId) {
    const quantity = prompt("Quantidade para vender:", "1");
    if (!quantity || isNaN(quantity) || quantity <= 0) return;
    
    if (!confirm(`Deseja vender ${quantity} unidade(s) deste item?`)) return;
    
    fetch("/items/store/sell/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": storeCsrftoken
        },
        body: JSON.stringify({
            item_id: itemId,
            quantity: parseInt(quantity)
        })
    }).then(r => r.json()).then(data => {
        if (data.success) {
            storeShowNotification('success', data.message || 'Item vendido com sucesso!');
            setTimeout(() => location.reload(), 1500);
        } else {
            storeShowNotification('error', data.error || 'Erro ao vender item');
        }
    }).catch(error => {
        console.error('Error:', error);
        storeShowNotification('error', 'Erro de conex√£o');
    });
}

// Sistema de notifica√ß√µes
function storeShowNotification(type, message) {
    // Criar elemento de notifica√ß√£o
    const notification = document.createElement('div');
    notification.className = 'store-notification';
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-family: 'Cinzel', serif;
        font-weight: bold;
        z-index: 10000;
        opacity: 0;
        transform: translateX(100px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        ${type === 'success' ? 'background: linear-gradient(45deg, #28a745, #20c997);' : ''}
        ${type === 'error' ? 'background: linear-gradient(45deg, #dc3545, #c82333);' : ''}
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        border: 1px solid ${type === 'success' ? 'rgba(32, 201, 151, 0.5)' : 'rgba(220, 53, 69, 0.5)'};
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.2rem;">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Anima√ß√£o de entrada
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Remover ap√≥s 3 segundos
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Efeito de entrada para a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.store-container');
    container.style.opacity = '0';
    container.style.transform = 'translateY(20px)';
    container.style.transition = 'opacity 0.5s, transform 0.5s';
    
    setTimeout(() => {
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
    }, 100);
    
    // Adicionar efeito de hover aos cards
    const cards = document.querySelectorAll('.store-item-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.boxShadow = '0 8px 25px rgba(255, 107, 107, 0.2)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.boxShadow = '';
        });
    });
});
</script>
{% endblock %}