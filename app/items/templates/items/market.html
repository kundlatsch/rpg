{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="scroll-container market-container">
    <!-- Cabe√ßalho do mercado -->
    <div class="market-header">
        <h1 class="market-title">üè™ Mercado</h1>
        <p class="market-subtitle">Compre e venda itens com outros aventureiros</p>
    </div>

    <!-- Dinheiro do personagem -->
    <div class="market-gold">
        <span class="market-gold-icon">üí∞</span>
        <span class="market-gold-text">Ouro: <span class="market-gold-amount">{{ character.gold }}</span></span>
    </div>

    <!-- Layout de duas colunas -->
    <div class="market-columns">
        <!-- Coluna da esquerda - Invent√°rio do usu√°rio -->
        <div class="market-section">
            <h2 class="market-section-title">üì¶ Seu Invent√°rio</h2>
            
            <!-- Tabs para tipos de itens -->
            <div class="market-tabs" id="market-inventory-tabs">
                <button class="market-tab-button active" data-target="market-inv-materials">
                    <span class="market-tab-icon">üì¶</span>
                    <span class="market-tab-label">Materiais</span>
                </button>
                <button class="market-tab-button" data-target="market-inv-equipment">
                    <span class="market-tab-icon">üõ°Ô∏è</span>
                    <span class="market-tab-label">Equipamentos</span>
                </button>
                <button class="market-tab-button" data-target="market-inv-consumables">
                    <span class="market-tab-icon">üß™</span>
                    <span class="market-tab-label">Consum√≠veis</span>
                </button>
            </div>

            <!-- Conte√∫do das tabs do invent√°rio -->
            <div class="market-tab-content">
                <!-- Materiais -->
                <div class="market-item-list" id="market-inv-materials">
                    {% for inv in user_materials %}
                    <div class="market-item-card market-rarity-{{ inv.item.rarity }}">
                        <div class="market-item-info">
                            <span class="market-item-emoji">{{ inv.item.emoji }}</span>
                            <div class="market-item-details">
                                <div class="market-item-name">{{ inv.item.name }}</div>
                                <div class="market-item-quantity">x{{ inv.quantity }}</div>
                            </div>
                        </div>
                        <div class="market-item-actions">
                            <button class="market-action-btn market-sell-btn" data-item-id="{{ inv.item.id }}">
                                üí∏ Vender
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="market-empty-message">Nenhum material no invent√°rio</div>
                    {% endfor %}
                </div>

                <!-- Equipamentos -->
                <div class="market-item-list" id="market-inv-equipment" style="display: none;">
                    {% for inv in user_equipment %}
                    <div class="market-item-card market-rarity-{{ inv.item.rarity }}">
                        <div class="market-item-info">
                            <span class="market-item-emoji">{{ inv.item.emoji }}</span>
                            <div class="market-item-details">
                                <div class="market-item-name">{{ inv.item.name }}</div>
                                <div class="market-item-quantity">x{{ inv.quantity }}</div>
                            </div>
                        </div>
                        <div class="market-item-actions">
                            <button class="market-action-btn market-sell-btn" data-item-id="{{ inv.item.id }}">
                                üí∏ Vender
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="market-empty-message">Nenhum equipamento no invent√°rio</div>
                    {% endfor %}
                </div>

                <!-- Consum√≠veis -->
                <div class="market-item-list" id="market-inv-consumables" style="display: none;">
                    {% for inv in user_consumables %}
                    <div class="market-item-card market-rarity-{{ inv.item.rarity }}">
                        <div class="market-item-info">
                            <span class="market-item-emoji">{{ inv.item.emoji }}</span>
                            <div class="market-item-details">
                                <div class="market-item-name">{{ inv.item.name }}</div>
                                <div class="market-item-quantity">x{{ inv.quantity }}</div>
                            </div>
                        </div>
                        <div class="market-item-actions">
                            <button class="market-action-btn market-sell-btn" data-item-id="{{ inv.item.id }}">
                                üí∏ Vender
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="market-empty-message">Nenhum consum√≠vel no invent√°rio</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Coluna da direita - Mercado -->
        <div class="market-section">
            <h2 class="market-section-title">üõí Itens √† Venda</h2>
            
            <!-- Tabs para tipos de itens no mercado -->
            <div class="market-tabs" id="market-sale-tabs">
                <button class="market-tab-button active" data-target="market-sale-materials">
                    <span class="market-tab-icon">üì¶</span>
                    <span class="market-tab-label">Materiais</span>
                </button>
                <button class="market-tab-button" data-target="market-sale-equipment">
                    <span class="market-tab-icon">üõ°Ô∏è</span>
                    <span class="market-tab-label">Equipamentos</span>
                </button>
                <button class="market-tab-button" data-target="market-sale-consumables">
                    <span class="market-tab-icon">üß™</span>
                    <span class="market-tab-label">Consum√≠veis</span>
                </button>
            </div>

            <!-- Conte√∫do das tabs do mercado -->
            <div class="market-tab-content">
                <!-- Materiais no mercado -->
                <div class="market-item-list" id="market-sale-materials">
                    {% for listing in market_materials %}
                        {% include "items/_market_listing_card.html" %}
                    {% empty %}
                    <div class="market-empty-message">Nenhum material √† venda</div>
                    {% endfor %}
                </div>

                <!-- Equipamentos no mercado -->
                <div class="market-item-list" id="market-sale-equipment" style="display: none;">
                    {% for listing in market_equipment %}
                        {% include "items/_market_listing_card.html" %}
                    {% empty %}
                    <div class="market-empty-message">Nenhum equipamento √† venda</div>
                    {% endfor %}
                </div>

                <!-- Consum√≠veis no mercado -->
                <div class="market-item-list" id="market-sale-consumables" style="display: none;">
                    {% for listing in market_consumables %}
                        {% include "items/_market_listing_card.html" %}
                    {% empty %}
                    <div class="market-empty-message">Nenhum consum√≠vel √† venda</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fun√ß√£o para gerenciar tabs
    function setupTabs(tabContainerId) {
        const tabButtons = document.querySelectorAll(`#${tabContainerId} .market-tab-button`);
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remover classe active de todos os bot√µes
                tabButtons.forEach(btn => btn.classList.remove('active'));
                
                // Adicionar classe active ao bot√£o clicado
                this.classList.add('active');
                
                // Esconder todos os conte√∫dos
                const container = this.closest('.market-section');
                const allContents = container.querySelectorAll('.market-item-list');
                allContents.forEach(content => {
                    content.style.display = 'none';
                });
                
                // Mostrar o conte√∫do correspondente
                const targetId = this.getAttribute('data-target');
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.style.display = 'block';
                }
            });
        });
    }
    
    // Inicializar tabs
    setupTabs('market-inventory-tabs');
    setupTabs('market-sale-tabs');
    
    // Fun√ß√£o para obter o token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrfToken = getCookie('csrftoken');
    
    /* =====================================================
                    BOT√ÉO DE VENDER
    ===================================================== */
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('market-sell-btn')) {
            const itemId = e.target.getAttribute('data-item-id');
            
            const quantity = prompt("Quantidade para vender:");
            if (!quantity || isNaN(quantity) || quantity <= 0) return;
            
            const price = prompt("Pre√ßo por unidade:");
            if (!price || isNaN(price) || price <= 0) return;
            
            fetch("/items/market/sell/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({
                    item_id: parseInt(itemId),
                    quantity: parseInt(quantity),
                    price: parseFloat(price),
                })
            })
            .then(r => r.json())
            .then(data => {
                alert(data.message || data.error);
                if (data.success) window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao vender item');
            });
        }
    });
    
    /* =====================================================
                    COMPRAR ITEM
    ===================================================== */
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('market-buy-btn')) {
            const listingId = e.target.getAttribute('data-listing-id');
            
            const quantity = prompt("Quantidade para comprar:");
            if (!quantity || isNaN(quantity) || quantity <= 0) return;
            
            fetch("/items/market/buy/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({
                    listing_id: parseInt(listingId),
                    quantity: parseInt(quantity)
                })
            })
            .then(r => r.json())
            .then(data => {
                alert(data.message || data.error);
                if (data.success) window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao comprar item');
            });
        }
    });
    
    /* =====================================================
                    CANCELAR AN√öNCIO
    ===================================================== */
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('market-cancel-btn')) {
            const listingId = e.target.getAttribute('data-listing-id');
            
            if (!confirm("Tem certeza que deseja cancelar este an√∫ncio?")) return;
            
            fetch("/items/market/cancel/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({
                    listing_id: parseInt(listingId)
                })
            })
            .then(r => r.json())
            .then(data => {
                alert(data.message || data.error);
                if (data.success) window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao cancelar an√∫ncio');
            });
        }
    });
    
    // Efeito de entrada
    const container = document.querySelector('.market-container');
    container.style.opacity = '0';
    container.style.transform = 'translateY(20px)';
    container.style.transition = 'opacity 0.5s, transform 0.5s';
    
    setTimeout(() => {
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
    }, 100);
});
</script>
{% endblock %}