{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/battle.css' %}">
{% endblock %}

{% block content %}
<div class="scroll-container battle-container">
    <!-- CabeÃ§alho do Combate -->
    <div class="battle-header">
        <h1 class="battle-title">
            âš”ï¸ Combate: {{ character.name }} vs {{ monster.name }}
        </h1>
        <p class="battle-subtitle">Batalha Ã‰pica em Andamento</p>
    </div>

    <!-- Status dos Combatentes -->
    <div class="battle-combatants-row">
        <!-- Personagem -->
        <div class="battle-combatant-card">
            <div class="battle-combatant-header">
                <span class="battle-combatant-emoji">{{ character.emoji }}</span>
                <h3 class="battle-combatant-name">{{ character.name }}</h3>
                <div class="battle-level-badge">NÃ­vel {{ character.level }}</div>
            </div>
            
            <div class="battle-hp-section">
                <div class="battle-status-label">
                    <span>â¤ï¸ Vida</span>
                    <span>{{ character.hp }} / {{ character.max_hp }}</span>
                </div>
                <div class="battle-status-bar">
                    <div class="battle-status-fill battle-health-fill" 
                         style="width: {% widthratio character.hp character.max_hp 100 %}%"></div>
                </div>
            </div>

            <div class="battle-mp-section">
                <div class="battle-status-label">
                    <span>ğŸ”® Mana</span>
                    <span>{{ character.mana }} / {{ character.max_mana }}</span>
                </div>
                <div class="battle-status-bar">
                    <div class="battle-status-fill battle-mana-fill" 
                         style="width: {% widthratio character.mana character.max_mana 100 %}%"></div>
                </div>
            </div>

            <!-- Atributos RÃ¡pidos -->
            <div class="battle-attributes-grid">
                <div class="battle-attribute-item">
                    <span class="battle-attribute-icon">ğŸ’ª</span>
                    <span class="battle-attribute-value">{{ character.strength }}</span>
                </div>
                <div class="battle-attribute-item">
                    <span class="battle-attribute-icon">ğŸ¯</span>
                    <span class="battle-attribute-value">{{ character.dexterity }}</span>
                </div>
                <div class="battle-attribute-item">
                    <span class="battle-attribute-icon">ğŸ”®</span>
                    <span class="battle-attribute-value">{{ character.arcane }}</span>
                </div>
                <div class="battle-attribute-item">
                    <span class="battle-attribute-icon">ğŸ›¡ï¸</span>
                    <span class="battle-attribute-value">{{ character.constitution }}</span>
                </div>
            </div>
        </div>

        <!-- Monstro -->
        <div class="battle-combatant-card">
            <div class="battle-combatant-header">
                <span class="battle-combatant-emoji">{{ monster.emoji }}</span>
                <h3 class="battle-combatant-name">{{ monster.name }}</h3>
                <div class="battle-level-badge">NÃ­vel {{ monster.level }}</div>
            </div>
            
            <div class="battle-hp-section">
                <div class="battle-status-label">
                    <span>â¤ï¸ Vida</span>
                    <span>{{ monster.hp }} / {{ monster.max_hp }}</span>
                </div>
                <div class="battle-status-bar">
                    <div class="battle-status-fill battle-health-fill" 
                         style="width: {% widthratio monster.hp monster.max_hp 100 %}%"></div>
                </div>
            </div>

            <div class="battle-mp-section">
                <div class="battle-status-label">
                    <span>ğŸ”® Mana</span>
                    <span>{{ monster.mana }} / {{ monster.max_mana }}</span>
                </div>
                <div class="battle-status-bar">
                    <div class="battle-status-fill battle-mana-fill" 
                         style="width: {% widthratio monster.mana monster.max_mana 100 %}%"></div>
                </div>
            </div>

            <!-- Atributos RÃ¡pidos -->
            <div class="battle-attributes-grid">
                <div class="battle-attribute-item">
                    <span class="battle-attribute-icon">ğŸ’ª</span>
                    <span class="battle-attribute-value">{{ monster.strength }}</span>
                </div>
                <div class="battle-attribute-item">
                    <span class="battle-attribute-icon">ğŸ¯</span>
                    <span class="battle-attribute-value">{{ monster.dexterity }}</span>
                </div>
                <div class="battle-attribute-item">
                    <span class="battle-attribute-icon">ğŸ”®</span>
                    <span class="battle-attribute-value">{{ monster.arcane }}</span>
                </div>
                <div class="battle-attribute-item">
                    <span class="battle-attribute-icon">ğŸ›¡ï¸</span>
                    <span class="battle-attribute-value">{{ monster.constitution }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Registro do Combate -->
    <div class="battle-log-section">
        <h3 class="battle-log-title">ğŸ“œ Registro da Batalha</h3>
        
        <div class="battle-log-container">
            {% for line in battle_log %}
                {% if "--- Turno" in line %}
                    <div class="battle-turn-divider">
                        <span class="battle-turn-number">{{ line }}</span>
                    </div>
                {% elif "acerta" in line or "cura" in line or "aplica" in line %}
                    <div class="battle-log-entry action-success">
                        <span class="battle-log-icon">âœ…</span>
                        <span class="battle-log-text">{{ line }}</span>
                    </div>
                {% elif "errou" in line or "falhou" in line %}
                    <div class="battle-log-entry action-miss">
                        <span class="battle-log-icon">âŒ</span>
                        <span class="battle-log-text">{{ line }}</span>
                    </div>
                {% elif "CRÃTICO" in line %}
                    <div class="battle-log-entry action-crit">
                        <span class="battle-log-icon">ğŸ’¥</span>
                        <span class="battle-log-text">{{ line }}</span>
                    </div>
                {% elif "morreu" in line or "derrotado" in line %}
                    <div class="battle-log-entry action-death">
                        <span class="battle-log-icon">ğŸ’€</span>
                        <span class="battle-log-text">{{ line }}</span>
                    </div>
                {% else %}
                    <div class="battle-log-entry">
                        <span class="battle-log-icon">ğŸ“</span>
                        <span class="battle-log-text">{{ line }}</span>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Resultado e EstatÃ­sticas -->
    <div class="battle-result-row">
        <!-- Resultado -->
        <div class="battle-result-banner 
            {% if winner == 'character' %}battle-victory-banner
            {% elif winner == 'monster' %}battle-defeat-banner
            {% else %}battle-draw-banner{% endif %}">
            {% if winner == "character" %}
                <div class="battle-result-emoji">ğŸ‰</div>
                <h3 class="battle-result-title battle-victory-title">VitÃ³ria Gloriosa!</h3>
                <p class="battle-result-text">VocÃª emerge vitorioso da batalha!</p>
            {% elif winner == "monster" %}
                <div class="battle-result-emoji">ğŸ’€</div>
                <h3 class="battle-result-title battle-defeat-title">Derrota</h3>
                <p class="battle-result-text">VocÃª foi derrotado em combate.</p>
            {% else %}
                <div class="battle-result-emoji">âš–ï¸</div>
                <h3 class="battle-result-title battle-draw-title">Empate</h3>
                <p class="battle-result-text">O combate terminou sem vencedor.</p>
            {% endif %}
        </div>
        
        <!-- EstatÃ­sticas -->
        <div class="battle-stats-section">
            <h4 class="battle-stats-title">ğŸ“Š EstatÃ­sticas</h4>
            <div class="battle-stats-grid">
                <div class="battle-stat-item">
                    <span class="battle-stat-label">Turnos</span>
                    <span class="battle-stat-value">{{ battle_stats.turns_taken }}</span>
                </div>
                <div class="battle-stat-item">
                    <span class="battle-stat-label">Acertos</span>
                    <span class="battle-stat-value">{{ battle_stats.hits }}</span>
                </div>
                <div class="battle-stat-item">
                    <span class="battle-stat-label">CrÃ­ticos</span>
                    <span class="battle-stat-value">{{ battle_stats.crits }}</span>
                </div>
                <div class="battle-stat-item">
                    <span class="battle-stat-label">Erros</span>
                    <span class="battle-stat-value">{{ battle_stats.misses }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- BotÃ£o de AÃ§Ã£o -->
    <div class="battle-action-container">
        <a href="{% url 'dashboard' %}" class="battle-return-btn">
            ğŸ° Retornar ao Dashboard
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Rolagem automÃ¡tica para o final do log
    const logContainer = document.querySelector('.battle-log-container');
    if (logContainer) {
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // Efeito de entrada para a pÃ¡gina
    const container = document.querySelector('.battle-container');
    container.style.opacity = '0';
    container.style.transform = 'translateY(20px)';
    container.style.transition = 'opacity 0.5s, transform 0.5s';
    
    setTimeout(() => {
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
    }, 100);
    
    // Efeito de pulsaÃ§Ã£o nas barras de vida se estiverem baixas
    const healthBars = document.querySelectorAll('.battle-health-fill');
    healthBars.forEach(bar => {
        const width = parseFloat(bar.style.width || '100');
        if (width < 30) {
            setInterval(() => {
                bar.style.opacity = bar.style.opacity === '0.7' ? '1' : '0.7';
            }, 800);
        }
    });
    
    // Efeito de brilho no botÃ£o de retorno
    const returnBtn = document.querySelector('.battle-return-btn');
    if (returnBtn) {
        setInterval(() => {
            returnBtn.style.boxShadow = returnBtn.style.boxShadow ? 
                '' : '0 0 20px rgba(255, 107, 107, 0.5)';
        }, 2000);
    }
});
</script>
{% endblock %}